DEFINE "main"
  // ========================================
  // フラグ定義 - 全フラグタイプを網羅
  // ========================================
  FLAG $hasKey           // アイテム所持フラグ
  FLAG $hasTorch         // アイテム所持フラグ
  FLAG $hasMap           // アイテム所持フラグ
  FLAG $doorUnlocked     // 状態フラグ
  FLAG $torchLit         // 状態フラグ
  FLAG $metOldMan        // イベントフラグ
  FLAG $heardRumor       // イベントフラグ
  FLAG $solvedPuzzle     // イベントフラグ
  FLAG $foughtBoss       // 戦闘フラグ
  FLAG $wasHighScore     // スコアフラグ
  FLAG $secretFound      // 隠し要素フラグ
  FLAG $badEnding        // エンディングフラグ


// ========================================
// エントリーポイント - EXEC命令のテスト
// ========================================
PAGE @start
EXEC #SET_BG "title_screen"
EXEC #PLAY_BGM "opening_theme"
> 古びた洋館の前に立つあなた。
- 雨が降りしきる中、不気味な雰囲気が漂っている。
- 扉は半開きで、中から微かな光が漏れている。
CHOICE
  IS "洋館に入る" @entrance
  IS "周囲を調べる" @outside_investigation
RETURN


// ========================================
// 複数フラグOR条件のテスト (true-or:)
// @^HERE と to-true: 効果のテスト
// ========================================
PAGE @outside_investigation
EXEC #SET_BG "mansion_outside"
> 洋館の周りを調べてみる。
false:$hasMap- 地面に古びた地図が落ちている。
false:$hasTorch- 壁際に松明が立てかけてある。
true-or:$hasMap,$hasTorch> すでに拾えるものは拾った。
CHOICE
  IS "地図を拾う" @^HERE false:$hasMap to-true:$hasMap
  IS "松明を拾う" @^HERE false:$hasTorch to-true:$hasTorch
  IS "洋館に入る" @entrance
RETURN


// ========================================
// 基本的な選択肢と状態遷移
// ========================================
PAGE @entrance
EXEC #SET_BG "entrance_hall"
EXEC #STOP_BGM
EXEC #PLAY_SE "door_creak"
> 洋館のエントランスホール。
- 埃まみれのシャンデリアが天井から吊るされている。
- 左右に扉があり、正面には大きな階段がある。
CHOICE
  IS "左の扉を開ける" @left_room
  IS "右の扉を開ける" @right_room
  IS "階段を上る" @upstairs
  IS "外に戻る" @outside_check
RETURN


// ========================================
// @^BACK メタコードのテスト
// ========================================
PAGE @outside_check
> 本当に外に出るのか？
- まだ何も調べていないが...
CHOICE
  IS "やはり中を調べる" @^BACK
  IS "外に出る" @give_up_ending
RETURN


// ========================================
// 単一フラグ条件のテスト (true:, false:)
// テキスト行での条件分岐テスト
// ========================================
PAGE @left_room
EXEC #SET_BG "library"
> 図書室のような部屋。
- 古い本が所狭しと並んでいる。
false:$metOldMan> 部屋の奥に老人が座っている。
true:$metOldMan> 老人はもういない。本だけが残されている。
CHOICE
  IS "老人に話しかける" @talk_to_old_man false:$metOldMan
  IS "本を調べる" @examine_books
  IS "エントランスに戻る" @entrance
RETURN


// ========================================
// 複数フラグ効果のテスト (to-true: 複数フラグ指定)
// IS行での条件付き選択肢テスト
// ========================================
PAGE @talk_to_old_man
EXEC #PLAY_SE "old_man_voice"
> 老人「よく来たな。この洋館の秘密を知りたいか？」
CHOICE
  IS "話を聞く" @old_man_story to-true:$metOldMan,$heardRumor
  IS "無視して去る" @left_room to-true:$metOldMan
RETURN


// ========================================
// 老人の話を聞く
// ========================================
PAGE @old_man_story
> 老人「この洋館には古い呪いがかかっている。」
- 老人「地下には秘密の部屋がある。」
- 老人「鍵と松明があれば、そこに辿り着けるだろう。」
CHOICE
  IS "ありがとう" @left_room
RETURN


// ========================================
// 時間制限付き選択肢のテスト (time:)
// /CANCEL, /TIMEUP のテスト
// ========================================
PAGE @examine_books
> 本棚を調べる。どの本を読もう？
CHOICE time:long
  IS "赤い本" @red_book
  IS "青い本" @blue_book
  IS "緑の本" @green_book
  IS "黄色い本" @yellow_book
  IS "黒い本" @black_book
  IS /CANCEL @left_room
  IS /TIMEUP @time_ran_out
RETURN


// ========================================
// 複数条件の組み合わせテスト
// 条件付きIS行とフラグ効果の組み合わせ
// ========================================
PAGE @red_book
> 赤い本「火の魔法について」
- 松明に火を灯す呪文が書かれている。
CHOICE
  IS "呪文を唱える" @light_torch false:$torchLit true:$hasTorch to-true:$torchLit
  IS "本を閉じる" @examine_books
RETURN


PAGE @blue_book
> 青い本「水の精霊の伝説」
- 特に役立つ情報はなかった。
CHOICE
  IS "戻る" @examine_books
RETURN


PAGE @green_book
> 緑の本「洋館の歴史」
- この洋館は100年前に建てられたらしい。
CHOICE
  IS "戻る" @examine_books
RETURN


PAGE @yellow_book
> 黄色い本「錬金術入門」
- 難解な内容で理解できなかった。
CHOICE
  IS "戻る" @examine_books
RETURN


PAGE @black_book
> 黒い本「禁断の儀式」
EXEC #PLAY_SE "ominous_sound"
- 読んではいけないものを読んでしまった気がする...
CHOICE
  IS "急いで本を閉じる" @examine_books to-true:$badEnding
RETURN


PAGE @time_ran_out
> 考えているうちに時間が経ちすぎてしまった。
- 何かの気配を感じて、慌てて本棚から離れる。
CHOICE
  IS "戻る" @left_room
RETURN


PAGE @light_torch
EXEC #PLAY_SE "fire_ignite"
> 呪文を唱えると、松明に火が灯った！
CHOICE
  IS "戻る" @left_room
RETURN


// ========================================
// 複数フラグAND条件のテスト (true: 複数フラグ指定)
// テキスト行での複数フラグ条件
// ========================================
PAGE @right_room
EXEC #SET_BG "treasure_room"
> 宝物室のような部屋。
- 中央に鍵のかかった宝箱がある。
false:$hasKey- 壁に古びた鍵が掛かっている。
true:$hasKey,$doorUnlocked> 開けた宝箱が空っぽで置かれている。
CHOICE
  IS "鍵を取る" @^HERE false:$hasKey to-true:$hasKey
  IS "宝箱を開ける" @open_chest true:$hasKey false:$doorUnlocked
  IS "エントランスに戻る" @entrance
RETURN


PAGE @open_chest
EXEC #PLAY_SE "chest_open"
> 宝箱を開けた！
- 中には古い日記が入っていた。
- 日記「地下室への扉は2階にある」
CHOICE
  IS "日記を読み終える" @right_room to-true:$doorUnlocked
RETURN


// ========================================
// 複数フラグOR条件（false-or:）のテスト
// 複数フラグAND条件との対比
// ========================================
PAGE @upstairs
EXEC #SET_BG "upstairs_hall"
> 2階の廊下。
- 長い廊下の奥に扉が見える。
false-or:$hasKey,$hasTorch> まだ準備が足りない気がする...
true:$hasKey,$hasTorch> 鍵と松明を持っている。準備は万端だ。
CHOICE
  IS "奥の扉を開ける" @locked_door false:$doorUnlocked
  IS "奥の扉を開ける" @basement_entrance true:$doorUnlocked
  IS "1階に戻る" @entrance
RETURN


// ========================================
// BACK 命令のテスト
// ========================================
PAGE @locked_door
> 扉には鍵穴があるが、開け方がわからない。
- 何か情報が必要だ。
BACK


// ========================================
// 連続EXEC命令のテスト
// 複数フラグ条件の組み合わせ
// ========================================
PAGE @basement_entrance
EXEC #STOP_BGM
EXEC #PLAY_SE "heavy_door"
EXEC #SET_BG "basement_stairs"
EXEC #PLAY_BGM "tension_theme"
> 扉を開けると、地下へと続く階段が現れた。
true:$torchLit> 松明の明かりが階段を照らす。
false:$torchLit> 暗くて足元が見えない。危険だ。
CHOICE
  IS "地下に降りる" @basement true:$torchLit
  IS "地下に降りる" @dark_basement false:$torchLit
  IS "やめて戻る" @upstairs
RETURN


PAGE @dark_basement
EXEC #SET_BG "pitch_black"
> 暗闇の中を進む...
EXEC #PLAY_SE "stumble"
- 足を滑らせて転んでしまった！
EXEC #PLAY_SE "game_over"
CHOICE
  IS "ゲームオーバー" @bad_ending_fall
RETURN


// ========================================
// /SAME 特殊選択肢のテスト
// 同じテキストを持つ選択肢の簡略記法
// ========================================
PAGE @basement
EXEC #SET_BG "basement"
> 地下室。松明の明かりで周囲が見渡せる。
- 部屋の中央に不思議な装置がある。
- 装置には3つのレバーがついている。
false:$solvedPuzzle> どのレバーを引くべきか...
true:$solvedPuzzle> 装置は既に作動している。奥への道が開いている。
CHOICE
  IS "左のレバーを引く" @wrong_lever_1 false:$solvedPuzzle
  IS "中央のレバーを引く" @correct_lever false:$solvedPuzzle
  IS "右のレバーを引く" @wrong_lever_2 false:$solvedPuzzle
  IS "奥の部屋に進む" @boss_room true:$solvedPuzzle
  IS /SAME @upstairs
RETURN


PAGE @wrong_lever_1
EXEC #PLAY_SE "wrong_buzzer"
> レバーを引いたが、何も起きなかった。
CHOICE
  IS "戻る" @basement
RETURN


PAGE @wrong_lever_2
EXEC #PLAY_SE "wrong_buzzer"
> レバーを引いたが、何も起きなかった。
CHOICE
  IS "戻る" @basement
RETURN


PAGE @correct_lever
EXEC #PLAY_SE "mechanism"
EXEC #PLAY_SE "door_unlock"
> レバーを引くと、装置が音を立てて動き出した！
- 奥の壁が開き、隠し部屋への道が現れた。
CHOICE
  IS "進む" @basement to-true:$solvedPuzzle
RETURN


// ========================================
// フラグ状態による分岐テスト
// ========================================
PAGE @boss_room
EXEC #SET_BG "boss_room"
EXEC #STOP_BGM
EXEC #PLAY_BGM "boss_theme"
> 隠し部屋。部屋の中央に巨大な影が立っている。
false:$foughtBoss> 影「よくここまで来たな。だが、ここで終わりだ！」
true:$foughtBoss> 倒れた影が横たわっている。
CHOICE
  IS "戦う" @boss_fight false:$foughtBoss
  IS "奥に進む" @final_room true:$foughtBoss
RETURN


// ========================================
// 時間制限付き選択肢のテスト
// /TIMEUP のテスト
// ========================================
PAGE @boss_fight
EXEC #PLAY_SE "battle_start"
> 影の攻撃は素早い！慎重に戦わなければ。
> 戦闘開始！
CHOICE time:normal
  IS "攻撃する" @boss_attack
  IS "防御する" @boss_defend
  IS /TIMEUP @boss_timeout
RETURN


// ========================================
// 3つ以上のフラグAND条件のテスト
// ========================================
PAGE @boss_attack
EXEC #PLAY_SE "sword_slash"
true:$hasKey,$torchLit,$solvedPuzzle> 完璧な準備が功を奏した！
- 渾身の一撃が影を貫いた！
EXEC #PLAY_SE "enemy_defeated"
CHOICE
  IS "勝利した" @boss_room to-true:$foughtBoss
RETURN


PAGE @boss_defend
> 防御に専念した。
- しかし、守りに徹しているだけでは勝てない！
CHOICE
  IS "再び攻撃" @boss_attack
RETURN


PAGE @boss_timeout
> 戦いが長引きすぎた！
- 体力が尽きてしまった...
EXEC #PLAY_SE "game_over"
CHOICE
  IS "ゲームオーバー" @bad_ending_timeout
RETURN


// ========================================
// 複数フラグの複雑な条件組み合わせテスト
// 3つのフラグAND条件 + 個別フラグ条件
// ========================================
PAGE @final_room
EXEC #SET_BG "final_room"
EXEC #STOP_BGM
EXEC #PLAY_BGM "ending_theme"
> 最奥の部屋。美しい宝石が台座に置かれている。
true:$hasMap,$metOldMan,$heardRumor> 地図と老人の話を思い出す。
- 台座の周りを調べると、隠しスイッチを発見した！
false:$hasMap- 特に何も見つからない。
CHOICE
  IS "隠しスイッチを押す" @secret_room true:$hasMap,$metOldMan
  IS "宝石を取る" @take_treasure
RETURN


PAGE @secret_room
EXEC #PLAY_SE "secret_found"
> 隠し部屋が開いた！
- 中には伝説の秘宝が眠っていた！
CHOICE
  IS "秘宝を手に入れる" @true_ending to-true:$secretFound
RETURN


PAGE @take_treasure
EXEC #PLAY_SE "item_get"
> 宝石を手に入れた。
CHOICE
  IS "洋館を出る" @normal_ending
RETURN


// ========================================
// TRUE ENDING - 複数EXEC命令とフラグ引数
// 大量フラグのリセット効果テスト
// ========================================
PAGE @true_ending
EXEC #STOP_BGM
EXEC #PLAY_SE "fanfare"
EXEC #SET_BG "true_ending"
> 秘宝を手に洋館を後にした。
- すべての謎を解き明かし、真の宝を手に入れた！
- *** TRUE ENDING ***
EXEC #SAVE_CLEAR_TIME $wasHighScore
true:$wasHighScore> クリアタイムハイスコア更新！
EXEC #UNLOCK_ACHIEVEMENT "true_ending"
EXEC #ROLL_CREDITS
CHOICE
  IS "タイトルに戻る" @start to-false:$hasKey,$hasTorch,$hasMap,$doorUnlocked,$torchLit,$metOldMan,$heardRumor,$solvedPuzzle,$foughtBoss,$secretFound,$badEnding
RETURN


// ========================================
// NORMAL ENDING - 条件分岐テスト
// ========================================
PAGE @normal_ending
EXEC #STOP_BGM
EXEC #PLAY_SE "ending_jingle"
EXEC #SET_BG "normal_ending"
> 宝石を手に洋館を後にした。
- まだ見ぬ秘密があった気がするが...
- *** NORMAL ENDING ***
true:$badEnding> （黒い本を読んだことが頭から離れない...）
EXEC #SAVE_CLEAR_TIME $wasHighScore
false:$wasHighScore> もっと早くクリアできたかもしれない。
CHOICE
  IS "タイトルに戻る" @start to-false:$hasKey,$hasTorch,$hasMap,$doorUnlocked,$torchLit,$metOldMan,$heardRumor,$solvedPuzzle,$foughtBoss,$secretFound,$badEnding
RETURN


// ========================================
// BAD ENDING - 準備不足
// ========================================
PAGE @bad_ending_fall
EXEC #SET_BG "game_over"
> 暗闇で転倒し、意識を失った...
- *** BAD ENDING: 準備不足 ***
- 松明を灯してから来るべきだった。
CHOICE
  IS "タイトルに戻る" @start to-false:$hasKey,$hasTorch,$hasMap,$doorUnlocked,$torchLit,$metOldMan,$heardRumor,$solvedPuzzle,$foughtBoss,$secretFound,$badEnding
RETURN


// ========================================
// BAD ENDING - 戦闘敗北
// ========================================
PAGE @bad_ending_timeout
EXEC #SET_BG "game_over"
> 力尽きて倒れてしまった...
- *** BAD ENDING: 戦闘敗北 ***
- もっと効率的に戦うべきだった。
CHOICE
  IS "タイトルに戻る" @start to-false:$hasKey,$hasTorch,$hasMap,$doorUnlocked,$torchLit,$metOldMan,$heardRumor,$solvedPuzzle,$foughtBoss,$secretFound,$badEnding
RETURN


// ========================================
// BAD ENDING - 探索放棄
// ========================================
PAGE @give_up_ending
EXEC #SET_BG "give_up"
> 洋館を後にした。
- *** BAD ENDING: 探索放棄 ***
- 何も得られなかった。
CHOICE
  IS "タイトルに戻る" @start
RETURN
